---
title: Rachel section
author: Rachel
date: 
output: pdf_document
---
# Regression on Spatial Data

## Overview of Data

Chicago has 77 neighbourhoods, which are called community areas. We can use the `read.socrata()` function to obtain the map of community areas from the Chicago Data Portal in the form of shapefiles:

```{r}
library(tidyverse)
library(RSocrata)
library(sf)
community_map <- read.socrata("https://data.cityofchicago.org/resource/igwz-8jzy.csv")
community_map <- community_map %>% select(c(the_geom, area = area_numbe)) %>% st_as_sf(wkt = "the_geom")
```

We can also obtain a record of 3 socio-economic indicators for each of the community areas for the years 2007-2011
```{r}
socio_ind <- read.socrata("https://data.cityofchicago.org/resource/i9hv-en6g.csv")
socio_ind <- socio_ind %>% select(-c(community_area_name))
head(socio_ind)
```
We can see there are 3 socio-economic indicators provided for each community area:

- `percent_households_below_poverty`: Percentage of households living the federal poverty line
- `per_capita_income_`: This is an estimation, calculated by aggregating incomes and dividing by the total population
- `hardship_index`: A score from 1-100 (a higher score indicates a greater level of hardship), incorporating 6 socio-economic indicators. More information on how this is calculated can be found in \textbf{REVISIT}
 
We now plot the map of chicago with respect to these indicators:
```{r}

library(gridExtra)
community_info <- left_join(community_map, socio_ind, by = c("area" = "ca"))

poverty_plot <- plot_heat_map(data = community_info, variable = "percent_households_below_poverty", legend.title = "Households \n in \n Poverty \n (%)", trans = "reverse")

income_plot <- plot_map(data = community_info, variable = "per_capita_income_", 
                         legend.title = "Per Capita \n Income ($)")

hardship_plot <- plot_map(data = community_info, variable = "hardship_index", 
                         legend.title = "Hardship \n Index", trans = "reverse")

grid.arrange(poverty_plot, income_plot, hardship_plot, nrow = 1)
```

## Regression In Time



```{r}
library(zoo)
complaints <- read.socrata("https://data.cityofchicago.org/resource/mft5-nfa8.csv")
complaints <- complaints %>% select(c(complaint_date, assignment))

data <- data_API
data <- data %>% filter(year(date ) <= 2019) 



complaints <- complaints %>% filter(year(complaint_date) <= 2019)

data <- data %>% mutate(month = as.yearmon(date)) %>%
  group_by(month) %>% dplyr::summarise(crimes = n())

complaints <- complaints %>% mutate(month = as.yearmon(complaint_date)) %>%
  group_by(month, assignment) %>% dplyr::summarise(cases = n())
 
min_date <- min(complaints$month)

data <- data %>% filter(month >=min_date)
crime_plot <- ggplot(data) +
  geom_line(aes(x= month, y = crimes)) +
  theme_minimal()

cases_plot <- ggplot()+
  geom_line(data = complaints, aes(x = month, y = cases, color = assignment)) +
  theme_minimal()

gridExtra::grid.arrange(crime_plot, cases_plot)
```

## Trigonometric Basis Function

```{r}
trig_transform <- function(X, b){
  phi <- matrix(nrow = 2*b, ncol = length(X))
  for (i in 1:b){
    phi[(2*i -1),] <- sin(i*X)
    phi[(2*i),] <- cos(i*X)
  }
  
  return(rbind(1,phi))
}


trig_coefficients <- function(X,y,b){
   phi <- trig_transform(X,b)
   w <- solve(phi %*% t(phi), phi %*% y)
   return(w)
}

trig_predicted <- function(X, w,b){
  phi <- trig_transform(X, b)
  y <- as.vector(t(w) %*% phi)
  return(y)
}
```



```{r}

data <- data %>% mutate(time = (1:nrow(data))/nrow(data))
df_train <- data %>% filter(year(month) <2019)
df_test <- data %>% filter(year(month) == 2019)

b <- 2
w <- trig_coefficients(df_train$time, df_train$crimes,b)

train_fitted <- trig_predicted(df_train$time, w, b)

test_fitted <- trig_predicted(df_test$time, w, b)

plot_data_train <- cbind(df_train, fitted = train_fitted, Data = "Train")
plot_data_test <-  cbind(df_test, fitted = test_fitted, Data = "Test")

plot_data <- rbind(plot_data_train, plot_data_test)

ggplot(plot_data) +
  geom_line(aes(x = month, y = fitted, color = Data)) +
  geom_point(aes(x = month, y = crimes)) + theme_minimal()
```
